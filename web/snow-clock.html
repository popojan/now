<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="/favicon.png" type="image/x-icon" />
    <title>Snow-Clock - 7-bit Mondrian Clock with Signature Encoding</title>
    <style>
        body { background-color: #DDDDDD; }
        tr { height: 10%; padding: 0; margin: 0;}
        td { border: 1vh solid #303030; text-align: center; vertical-align: center; padding:0; margin:0;}
        td.c20 { width: 66.6667%; height: 50%; }
        td.c15 { width: 50%; height: 50%; }
        td.c12 { width: 33.3334%; height: 60%; }
        td.c6 { width: 50%; height: 20%; }
        td.c4 { width: 33.3334%; height: 20%; }
        td.c2 { width: 16.6667%; height: 20%; }
        td.c1 { width: 16.6667%; height: 10%; }
        table {
            border-collapse: collapse;
            table-layout: fixed;
            width: 36vh;
            height: 60vh;
            margin: 0;
            padding: 0;
            color: rgba(0,0,0,0.5);
            font-family: sans-serif;
            font-weight: bold;
            font-size: 250%;
            box-shadow: 1vh 1vh 2vh #A0A0A0;
            background-color: #FFFFFF;
        }
        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px;
        }
        #info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
            max-width: 90%;
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-radius: 4px;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            font-family: sans-serif;
            font-size: 14px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 400px;
        }
        #controls input[type="text"] {
            width: 120px;
            padding: 5px;
            font-family: monospace;
        }
        #controls button {
            padding: 5px 15px;
            margin-left: 5px;
            cursor: pointer;
        }
        #controls label {
            display: block;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
        .hidden { display: none; }
        .stats {
            margin-top: 10px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 11px;
            font-family: monospace;
            line-height: 1.4;
        }
        .highlight { color: #d32f2f; font-weight: bold; }
        .period { color: #1976d2; font-weight: bold; }
        #minuteCounter {
            font-size: 16px;
            font-family: monospace;
            padding: 10px;
            background: #222;
            color: #0f0;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
            letter-spacing: 1px;
        }
        #secondBar {
            width: 100%;
            height: 4px;
            background: #ddd;
            margin-top: 8px;
            border-radius: 2px;
        }
        #secondProgress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 2px;
            transition: width 0.05s;
        }
        .param-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        .param-row label {
            margin: 0;
            min-width: 20px;
        }
    </style>
</head>
<body>
    <div class="center">
        <table>
            <tr><td id="c20" class="c20" rowspan="5" colspan="4"></td>
                <td id="c12" class="c12" rowspan="6" colspan="2"></td>
            </tr>
            <tr></tr>
            <tr></tr>
            <tr></tr>
            <tr></tr>
            <tr>
                <td id="c15" class="c15" rowspan="5" colspan="3"></td>
                <td id="c1" class="c1" rowspan="1" colspan="1"></td>
            </tr>
            <tr>
                <td id="c2" class="c2" rowspan="2" colspan="1"></td>
                <td id="c4" class="c4" rowspan="2" colspan="2"></td>
            </tr>
            <tr></tr>
            <tr>
                <td id="c6" class="c6" rowspan="2" colspan="3"></td>
            </tr>
            <tr></tr>
        </table>
    </div>
    <div id="controls">
        <div class="param-row">
            <label>Origin:</label>
            <input type="text" id="originInput" placeholder="ISO 8601 or 'now'" style="width:180px">
            <button onclick="setOrigin()">Set</button>
            <button onclick="setOriginNow()">Now</button>
        </div>
        <div style="margin-top:10px">Signature Encoding</div>
        <div class="param-row">
            <label>P:</label>
            <input type="text" id="paramP" placeholder="Period divisor" value="1">
            <label>N:</label>
            <input type="text" id="paramN" placeholder="Value" value="0">
            <button onclick="setParams()">Set</button>
        </div>
        <div id="minuteCounter">Minute: 0</div>
        <div id="secondBar"><div id="secondProgress"></div></div>
        <label>
            <input type="checkbox" id="showControls" checked onchange="toggleControls()"> Show controls (press 'c' to toggle)
        </label>
        <div class="stats">
            <div>Cells: {1,2,4,6,12,15,20} sum=60</div>
            <div>Combos per second: 1-4</div>
            <div>Period: <span class="period">2^30 x 3^16</span> minutes</div>
            <div>= 88 billion years</div>
            <div>Entropy: <span class="highlight">6.94 bits/second</span> (99.1%)</div>
            <div id="eraInfo"></div>
        </div>
    </div>
    <div id="info"></div>
<script type="text/javascript">
    // Mondrian colors - original design
    const colors = {
        20: "rgba(255,255,0,1.0)",   // yellow
        15: "rgba(255,0,0,1.0)",     // red
        12: "rgba(0,0,255,1.0)",     // blue
        6:  "rgba(0,0,255,1.0)",     // blue
        4:  "rgba(30,30,30,1.0)",    // black
        2:  "rgba(255,255,0,1.0)",   // yellow
        1:  "rgba(30,30,30,1.0)"     // black
    };

    const CELLS = [1, 2, 4, 6, 12, 15, 20];

    const ordering = {
        0: [[1, 2, 4, 6, 12, 15, 20], []],
        1: [[1]], 2: [[2]], 3: [[1, 2]], 4: [[4]], 5: [[1, 4]],
        6: [[6], [2, 4]], 7: [[1, 6], [1, 2, 4]], 8: [[2, 6]], 9: [[1, 2, 6]],
        10: [[4, 6]], 11: [[1, 4, 6]], 12: [[12], [2, 4, 6]], 13: [[1, 12], [1, 2, 4, 6]],
        14: [[2, 12]], 15: [[15], [1, 2, 12]], 16: [[1, 15], [4, 12]],
        17: [[2, 15], [1, 4, 12]], 18: [[1, 2, 15], [6, 12], [2, 4, 12]],
        19: [[4, 15], [1, 6, 12], [1, 2, 4, 12]], 20: [[20], [1, 4, 15], [2, 6, 12]],
        21: [[1, 20], [6, 15], [2, 4, 15], [1, 2, 6, 12]],
        22: [[2, 20], [1, 6, 15], [1, 2, 4, 15], [4, 6, 12]],
        23: [[1, 2, 20], [2, 6, 15], [1, 4, 6, 12]], 24: [[4, 20], [1, 2, 6, 15], [2, 4, 6, 12]],
        25: [[1, 4, 20], [4, 6, 15], [1, 2, 4, 6, 12]], 26: [[6, 20], [2, 4, 20], [1, 4, 6, 15]],
        27: [[1, 6, 20], [1, 2, 4, 20], [12, 15], [2, 4, 6, 15]],
        28: [[1, 12, 15], [2, 6, 20], [1, 2, 4, 6, 15]], 29: [[1, 2, 6, 20], [2, 12, 15]],
        30: [[1, 2, 12, 15], [4, 6, 20]], 31: [[1, 4, 6, 20], [4, 12, 15]],
        32: [[12, 20], [1, 4, 12, 15], [2, 4, 6, 20]],
        33: [[1, 12, 20], [1, 2, 4, 6, 20], [6, 12, 15], [2, 4, 12, 15]],
        34: [[2, 12, 20], [1, 6, 12, 15], [1, 2, 4, 12, 15]],
        35: [[15, 20], [1, 2, 12, 20], [2, 6, 12, 15]],
        36: [[1, 15, 20], [4, 12, 20], [1, 2, 6, 12, 15]],
        37: [[2, 15, 20], [1, 4, 12, 20], [4, 6, 12, 15]],
        38: [[1, 2, 15, 20], [6, 12, 20], [2, 4, 12, 20], [1, 4, 6, 12, 15]],
        39: [[4, 15, 20], [1, 6, 12, 20], [1, 2, 4, 12, 20], [2, 4, 6, 12, 15]],
        40: [[1, 4, 15, 20], [2, 6, 12, 20], [1, 2, 4, 6, 12, 15]],
        41: [[6, 15, 20], [2, 4, 15, 20], [1, 2, 6, 12, 20]],
        42: [[1, 6, 15, 20], [1, 2, 4, 15, 20], [4, 6, 12, 20]],
        43: [[2, 6, 15, 20], [1, 4, 6, 12, 20]], 44: [[1, 2, 6, 15, 20], [2, 4, 6, 12, 20]],
        45: [[4, 6, 15, 20], [1, 2, 4, 6, 12, 20]], 46: [[1, 4, 6, 15, 20]],
        47: [[12, 15, 20], [2, 4, 6, 15, 20]], 48: [[1, 12, 15, 20], [1, 2, 4, 6, 15, 20]],
        49: [[2, 12, 15, 20]], 50: [[1, 2, 12, 15, 20]], 51: [[4, 12, 15, 20]],
        52: [[1, 4, 12, 15, 20]], 53: [[6, 12, 15, 20], [2, 4, 12, 15, 20]],
        54: [[1, 6, 12, 15, 20], [1, 2, 4, 12, 15, 20]], 55: [[2, 6, 12, 15, 20]],
        56: [[1, 2, 6, 12, 15, 20]], 57: [[4, 6, 12, 15, 20]], 58: [[1, 4, 6, 12, 15, 20]],
        59: [[2, 4, 6, 12, 15, 20]]
    };

    // Period constant: 2^30 * 3^16 minutes
    const CLOCK_PERIOD = 46221064723759104n;

    // Signature parameters
    let sigP = 1n;  // Period divisor
    let sigN = 0n;  // Signature value (0 to P-1)

    // Parse URL parameters
    const params = new URLSearchParams(window.location.search);
    let origin = new Date(params.get('origin') || "1970-01-01T00:00:00Z");
    const initialP = params.get('P') || params.get('p') || "1";
    const initialN = params.get('N') || params.get('n') || "0";
    const hideControls = params.get('controls') === '0';

    function integerDigitsBasePad(n, base, width) {
        return n.toString(base).padStart(width, "0").split("").map(x => parseInt(x));
    }

    function perm(minute, P, N) {
        // Signature encoding: k = minute * P + N
        // P detectable from k-delta between consecutive minutes
        // Full PERIOD preserved when P is coprime with 2 and 3
        let k = (minute * P + N) % CLOCK_PERIOD;

        // Original 7-bit permutation algorithm
        let ret = [];
        let k3 = integerDigitsBasePad((k - k % 1073741824n) / 1073741824n, 3, 16);
        let rest = integerDigitsBasePad(k % 1073741824n, 2, 30);
        let k4 = [];
        let k2 = rest.slice(0, 18);
        for (let i = 0; i < 12; i += 2) {
            k4.push(parseInt(rest.slice(i + 18, i + 20).join(""), 2));
        }
        for (let i = 0; i < 60; ++i) {
            let m = ordering[i].length;
            if (m === 1) ret.push(0);
            else if (m === 2) ret.push(k2.shift());
            else if (m === 3) ret.push(k3.shift());
            else if (m === 4) ret.push(k4.shift());
        }
        return ret;
    }

    function setOrigin() {
        const val = document.getElementById('originInput').value.trim();
        if (!val) return;
        if (val.toLowerCase() === 'now') {
            setOriginNow();
            return;
        }
        try {
            const newOrigin = new Date(val);
            if (isNaN(newOrigin.getTime())) {
                alert('Invalid date format. Use ISO 8601 (e.g., 2024-01-01T00:00:00Z) or "now"');
                return;
            }
            origin = newOrigin;
            updateOriginDisplay();
            updateURL();
        } catch (e) {
            alert('Invalid date format');
        }
    }

    function setOriginNow() {
        // Floor to start of current minute for sync with wall clock
        origin = new Date(Math.floor(Date.now() / 60000) * 60000);
        updateOriginDisplay();
        updateURL();
    }

    function updateOriginDisplay() {
        // Strip milliseconds from ISO string (not used)
        document.getElementById('originInput').value = origin.toISOString().replace(/\.\d{3}Z$/, 'Z');
    }

    function updateURL() {
        const url = new URL(window.location);
        url.searchParams.set('origin', origin.toISOString());
        if (sigP > 1n) {
            url.searchParams.set('P', sigP.toString());
            url.searchParams.set('N', sigN.toString());
        } else {
            url.searchParams.delete('P');
            url.searchParams.delete('N');
        }
        window.history.replaceState({}, '', url);
    }

    function setParams() {
        const pVal = document.getElementById('paramP').value;
        const nVal = document.getElementById('paramN').value;

        try {
            const newP = BigInt(pVal);
            const newN = BigInt(nVal);

            if (newP < 1n) {
                alert('P must be >= 1');
                return;
            }
            if (newN < 0n || newN >= newP) {
                alert(`N must be in range [0, ${newP - 1n}]`);
                return;
            }

            sigP = newP;
            sigN = newN;

            updateURL();
            updateEraInfo();
        } catch (e) {
            alert('Invalid number format');
        }
    }

    function updateEraInfo() {
        const eraInfo = document.getElementById('eraInfo');
        if (sigP <= 1n) {
            eraInfo.textContent = 'Signature: disabled (P=1)';
        } else {
            // Simple formula: k = minute * P + N
            // P detectable from k-delta, full PERIOD preserved
            eraInfo.innerHTML = `Signature: P=<span class="highlight">${sigP}</span> N=${sigN}`;
        }
    }

    function toggleControls() {
        const show = document.getElementById('showControls').checked;
        document.getElementById('controls').className = show ? '' : 'hidden';
    }

    // Initialize
    document.getElementById('paramP').value = initialP;
    document.getElementById('paramN').value = initialN;

    try {
        sigP = BigInt(initialP);
        sigN = BigInt(initialN);
        if (sigP < 1n) sigP = 1n;
        if (sigN < 0n || sigN >= sigP) sigN = 0n;
    } catch (e) {
        sigP = 1n;
        sigN = 0n;
    }

    if (hideControls) {
        document.getElementById('showControls').checked = false;
        document.getElementById('controls').className = 'hidden';
    }

    updateEraInfo();
    updateOriginDisplay();

    // Main loop
    setInterval(function() {
        const now = Date.now();
        const t = BigInt(Math.floor((now - origin) / 1000));
        const currentSecond = Number(t % 60n);
        const minute = t / 60n;

        const tt = perm(minute, sigP, sigN);
        const cells = ordering[currentSecond][tt[currentSecond]];

        // Update all 7 cells
        for (const cellWeight of CELLS) {
            const el = document.getElementById('c' + cellWeight);
            const visible = cells.includes(cellWeight);
            el.style.opacity = visible ? "100%" : "0%";
            el.style.backgroundColor = colors[cellWeight];
        }

        // Update minute counter with signature info
        let counterText = `Minute: ${minute} | Second: ${currentSecond}`;
        if (sigP > 1n) {
            counterText += ` | Signature: N=${sigN}`;
        }
        document.getElementById('minuteCounter').textContent = counterText;

        // Update second progress bar
        document.getElementById('secondProgress').style.width =
            ((currentSecond + 1) / 60 * 100) + '%';

        // Update info
        const mask = (cells.includes(1) ? 1 : 0) |
                    (cells.includes(2) ? 2 : 0) |
                    (cells.includes(4) ? 4 : 0) |
                    (cells.includes(6) ? 8 : 0) |
                    (cells.includes(12) ? 16 : 0) |
                    (cells.includes(15) ? 32 : 0) |
                    (cells.includes(20) ? 64 : 0);
        const sum = cells.reduce((a, b) => a + b, 0);
        const combosForSecond = ordering[currentSecond].length;

        document.getElementById('info').innerHTML =
            `Second: <b>${currentSecond}</b> | ` +
            `Sum: ${sum} | ` +
            `Combo: ${tt[currentSecond] + 1}/${combosForSecond} | ` +
            `Mask: 0x${mask.toString(16).padStart(2,'0')} | ` +
            `Cells: [${cells.length > 0 ? cells.join('+') : 'none'}]`;

    }, 50);

    // Keyboard: 'c' to toggle controls
    document.addEventListener('keydown', (e) => {
        if ((e.key === 'c' || e.key === 'C') && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            const checkbox = document.getElementById('showControls');
            checkbox.checked = !checkbox.checked;
            toggleControls();
        }
    });
</script>
</body>
</html>
