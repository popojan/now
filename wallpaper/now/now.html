<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Now</title>
    <style>
        body { background-color: #DDDDDD; margin: 0; }
        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .clock {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 36vh;
            height: 60vh;
            gap: 1vh;
            padding: 1vh;
            background-color: #303030;
            box-shadow: 1vh 1vh 2vh #A0A0A0;
        }
        .cell {
            background-color: #FFFFFF;
        }
        /* Cell positions: 6 columns Ã— 10 rows */
        .c20 { grid-column: 1 / 5; grid-row: 1 / 6; }   /* cols 1-4, rows 1-5 */
        .c12 { grid-column: 5 / 7; grid-row: 1 / 7; }   /* cols 5-6, rows 1-6 */
        .c15 { grid-column: 1 / 4; grid-row: 6 / 11; }  /* cols 1-3, rows 6-10 */
        .c1  { grid-column: 4 / 5; grid-row: 6 / 7; }   /* col 4, row 6 */
        .c2  { grid-column: 4 / 5; grid-row: 7 / 9; }   /* col 4, rows 7-8 */
        .c4  { grid-column: 5 / 7; grid-row: 7 / 9; }   /* cols 5-6, rows 7-8 */
        .c6  { grid-column: 4 / 7; grid-row: 9 / 11; }  /* cols 4-6, rows 9-10 */
        /* Mondrian colors */
        .c20 { background-color: rgba(255,255,0,1.0); }  /* Yellow */
        .c15 { background-color: rgba(255,0,0,1.0); }    /* Red */
        .c12 { background-color: rgba(0,0,255,1.0); }    /* Blue */
        .c6  { background-color: rgba(0,0,255,1.0); }    /* Blue */
        .c4  { background-color: rgba(30,30,30,1.0); }   /* Black */
        .c2  { background-color: rgba(255,255,0,1.0); }  /* Yellow */
        .c1  { background-color: rgba(30,30,30,1.0); }   /* Black */
    </style>
</head>
<body onclick="togglePeriod();">
    <div class="center">
        <div class="clock" id="now">
            <div class="cell c20" id="20"></div>
            <div class="cell c12" id="12"></div>
            <div class="cell c15" id="15"></div>
            <div class="cell c1" id="1"></div>
            <div class="cell c2" id="2"></div>
            <div class="cell c4" id="4"></div>
            <div class="cell c6" id="6"></div>
        </div>
        <div id="warning" style="display:none; color:red; text-align:center; margin-top:1vh; font-family:sans-serif; font-size:1.5vh;">
            Invalid origin, use e.g. 1970-01-01T00:00:00Z
        </div>
    </div>
<script type="text/javascript">
    let ordering = {
        0: [[1, 2, 4, 6, 12, 15, 20], []],
        1: [[1]],
        2: [[2]],
        3: [[1, 2]],
        4: [[4]],
        5: [[1, 4]],
        6: [[6], [2, 4]],
        7: [[1, 6], [1, 2, 4]],
        8: [[2, 6]],
        9: [[1, 2, 6]],
        10: [[4, 6]],
        11: [[1, 4, 6]],
        12: [[12], [2, 4, 6]],
        13: [[1, 12], [1, 2, 4, 6]],
        14: [[2, 12]],
        15: [[15], [1, 2, 12]],
        16: [[1, 15], [4, 12]],
        17: [[2, 15], [1, 4, 12]],
        18: [[1, 2, 15], [6, 12], [2, 4, 12]],
        19: [[4, 15], [1, 6, 12], [1, 2, 4, 12]],
        20: [[20], [1, 4, 15], [2, 6, 12]],
        21: [[1, 20], [6, 15], [2, 4, 15], [1, 2, 6, 12]],
        22: [[2, 20], [1, 6, 15], [1, 2, 4, 15], [4, 6, 12]],
        23: [[1, 2, 20], [2, 6, 15], [1, 4, 6, 12]],
        24: [[4, 20], [1, 2, 6, 15], [2, 4, 6, 12]],
        25: [[1, 4, 20], [4, 6, 15], [1, 2, 4, 6, 12]],
        26: [[6, 20], [2, 4, 20], [1, 4, 6, 15]],
        27: [[1, 6, 20], [1, 2, 4, 20], [12, 15], [2, 4, 6, 15]],
        28: [[1, 12, 15], [2, 6, 20], [1, 2, 4, 6, 15]],
        29: [[1, 2, 6, 20], [2, 12, 15]],
        30: [[1, 2, 12, 15], [4, 6, 20]],
        31: [[1, 4, 6, 20], [4, 12, 15]],
        32: [[12, 20], [1, 4, 12, 15], [2, 4, 6, 20]],
        33: [[1, 12, 20], [1, 2, 4, 6, 20], [6, 12, 15], [2, 4, 12, 15]],
        34: [[2, 12, 20], [1, 6, 12, 15], [1, 2, 4, 12, 15]],
        35: [[15, 20], [1, 2, 12, 20], [2, 6, 12, 15]],
        36: [[1, 15, 20], [4, 12, 20], [1, 2, 6, 12, 15]],
        37: [[2, 15, 20], [1, 4, 12, 20], [4, 6, 12, 15]],
        38: [[1, 2, 15, 20], [6, 12, 20], [2, 4, 12, 20], [1, 4, 6, 12, 15]],
        39: [[4, 15, 20], [1, 6, 12, 20], [1, 2, 4, 12, 20], [2, 4, 6, 12, 15]],
        40: [[1, 4, 15, 20], [2, 6, 12, 20], [1, 2, 4, 6, 12, 15]],
        41: [[6, 15, 20], [2, 4, 15, 20], [1, 2, 6, 12, 20]],
        42: [[1, 6, 15, 20], [1, 2, 4, 15, 20], [4, 6, 12, 20]],
        43: [[2, 6, 15, 20], [1, 4, 6, 12, 20]],
        44: [[1, 2, 6, 15, 20], [2, 4, 6, 12, 20]],
        45: [[4, 6, 15, 20], [1, 2, 4, 6, 12, 20]],
        46: [[1, 4, 6, 15, 20]],
        47: [[12, 15, 20], [2, 4, 6, 15, 20]],
        48: [[1, 12, 15, 20], [1, 2, 4, 6, 15, 20]],
        49: [[2, 12, 15, 20]],
        50: [[1, 2, 12, 15, 20]],
        51: [[4, 12, 15, 20]],
        52: [[1, 4, 12, 15, 20]],
        53: [[6, 12, 15, 20], [2, 4, 12, 15, 20]],
        54: [[1, 6, 12, 15, 20], [1, 2, 4, 12, 15, 20]],
        55: [[2, 6, 12, 15, 20]],
        56: [[1, 2, 6, 12, 15, 20]],
        57: [[4, 6, 12, 15, 20]],
        58: [[1, 4, 6, 12, 15, 20]],
        59: [[2, 4, 6, 12, 15, 20]]
    };
    let origin0 = "1970-01-01T00:00:00Z";
    let origin = new Date(origin0);
    let tick = 1n;
    let period = 60n;
    let sigP = 1n;  // Signature period (must be coprime with 60)
    let sigN = 0n;  // Signature value (0 to P-1)

    function togglePeriod() {
        if(tick <= 1n) {
            tick = 60n;
            period = 60n;
        } else if(tick <= 60n) {
            tick = 3600n;
            period = 24n;
        } else {
            tick = 1n;
            period = 60n;
        }
    }

    // Parse and validate origin, show warning if invalid
    function setOrigin(input) {
        const warningEl = document.getElementById("warning");
        if (!input || input.trim() === "") {
            origin = new Date(origin0);
            warningEl.style.display = "none";
        } else {
            const parsed = new Date(input.trim());
            if (isNaN(parsed.getTime())) {
                origin = new Date(origin0);
                warningEl.style.display = "block";
            } else {
                origin = parsed;
                warningEl.style.display = "none";
            }
        }
    }

    const param = new URLSearchParams(window.location.search);
    try {
        setOrigin(param.get('origin'));
        tick = BigInt(param.get('period')||"1");
        period = BigInt(param.get('mod')||"60");
        // Signature encoding: k_combined = minute * P + N
        sigP = BigInt(param.get('P')||"1");
        sigN = BigInt(param.get('N')||"0");
        // Validate: N must be < P
        if (sigN >= sigP) sigN = sigN % sigP;
    } catch (error) {
        console.log(error);
        origin = new Date(origin0);
        tick = 1n;
        period = 60n;
        sigP = 1n;
        sigN = 0n;
    }

    // Store original colors for each cell
    const originalColors = {};
    for(const i of [1, 2, 4, 6, 12, 15, 20]) {
        const el = document.getElementById(i.toString());
        originalColors[i] = getComputedStyle(el).backgroundColor;
    }

    // Empty color (can be changed by wallpaper engine)
    let emptyColor = "#FFFFFF";

    function integerDigitsBasePad(n, base, width) {
        return n.toString(base).padStart(width, "0").split("").map(
            function(x, i, a) {
                return parseInt(x);
            }
        );
    }
    function perm(t) {
        let k = t % 46221064723759104n;
        let ret = [];
        let k3 = integerDigitsBasePad((k - k % 1073741824n)/(1073741824n), 3, 16);
        let rest = integerDigitsBasePad(k % 1073741824n, 2, 30);
        let k4 = [];
        let k2 = rest.slice(0, 18);
        for(let i = 0; i < 12; i += 2) {
            k4.push(parseInt(rest.slice(i + 18, i + 20).join(""), 2));
        }
        for(let i = 0; i < 60; ++i) {
            let m = ordering[i].length;
            if(m === 1) {
                ret.push(0);
            } else if (m === 2) {
                ret.push(k2.shift());
            } else if (m === 3) {
                ret.push(k3.shift());
            } else if (m === 4) {
                ret.push(k4.shift());
            }
        }
        return ret;
    }
    const CLOCK_PERIOD = 46221064723759104n;
    setInterval(function() {
        let t = BigInt(Math.floor((Date.now() - origin)/1000.0));
        t = (t + period * tick * CLOCK_PERIOD) % (60n * CLOCK_PERIOD * period * tick);
        let minute = t / (period * tick);
        // Signature encoding: k = minute * P + N
        // P detectable from k-delta between consecutive minutes
        // Full PERIOD preserved when P is coprime with 2 and 3
        let k = (minute * sigP + sigN) % CLOCK_PERIOD;
        let tt = perm(k);

        // Secondary displays (minutes/hours) use local system time directly
        let ord;
        if (tick === 1n) {
            ord = (t / tick) % period;  // Seconds from UTC-based calculation
        } else if (tick === 60n) {
            ord = BigInt(new Date().getMinutes());  // Local minutes
        } else {
            ord = BigInt(new Date().getHours());    // Local hours
        }

        let s = ordering[ord][tt[ord]];
        for(const i of [1, 2, 4, 6, 12, 15, 20]) {
            let el = document.getElementById(i.toString());
            if(s.indexOf(i) > -1) {
                el.style.backgroundColor = originalColors[i];
            } else {
                el.style.backgroundColor = emptyColor;
            }
        }
    }, 25);

    function rgb(c) {
        var color = c.value.split(' ');
        color = color.map(function(c) {
            return Math.ceil(c * 255);
        });
        return 'rgb(' + color + ')';
    }

    window.wallpaperPropertyListener = {
        applyUserProperties: function(properties) {
            if (properties.backgroundcolor) {
                document.body.style.backgroundColor = rgb(properties.backgroundcolor);
            }
            if (properties.shadowcolor) {
                document.getElementById("now").style.boxShadow = '1vh 1vh 2vh ' + rgb(properties.shadowcolor);
            }
            if (properties.emptycolor) {
                emptyColor = rgb(properties.emptycolor);
            }
            if (properties.bordercolor) {
                document.getElementById("now").style.backgroundColor = rgb(properties.bordercolor);
            }
            if (properties.borderwidth) {
                document.getElementById("now").style.gap = properties.borderwidth.value + 'vh';
                document.getElementById("now").style.padding = properties.borderwidth.value + 'vh';
            }
            if (properties.color20) {
                originalColors[20] = rgb(properties.color20);
            }
            if (properties.color15) {
                originalColors[15] = rgb(properties.color15);
            }
            if (properties.color12) {
                originalColors[12] = rgb(properties.color12);
            }
            if (properties.color6) {
                originalColors[6] = rgb(properties.color6);
            }
            if (properties.color4) {
                originalColors[4] = rgb(properties.color4);
            }
            if (properties.color2) {
                originalColors[2] = rgb(properties.color2);
            }
            if (properties.color1) {
                originalColors[1] = rgb(properties.color1);
            }
            if (properties.origin) {
                setOrigin(properties.origin.value);
            }
            if (properties.signaturep) {
                sigP = BigInt(properties.signaturep.value || "1");
                if (sigP < 1n) sigP = 1n;
            }
            if (properties.signaturen) {
                sigN = BigInt(properties.signaturen.value || "0");
                if (sigN >= sigP) sigN = sigN % sigP;
            }
        }
    };

</script>
</body>
</html>
